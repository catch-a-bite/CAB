<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>로그인</title>

  <style>
    :root {
      --bg: #f5f3ef;
      --panel: #ffffff;
      --text: #2b2a28;
      --muted: #6e6860;
      --line: #d6d0c8;
      --accent: #6a645c;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: "Noto Sans KR", "Apple SD Gothic Neo", sans-serif;
    }

    .login-shell {
      width: min(420px, 92vw);
      margin: 72px auto;
      padding: 28px 26px 24px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: var(--panel);
      box-shadow: 0 18px 40px rgba(28, 24, 20, 0.08);
    }

    .login-title {
      font-size: 22px;
      margin: 0 0 14px;
    }

    .login-sub {
      margin: 0 0 18px;
      font-size: 13px;
      color: var(--muted);
    }

    label {
      display: block;
      margin: 12px 0 6px;
      font-size: 13px;
      color: var(--muted);
    }

    input {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 14px;
      font-family: inherit;
    }

    input:focus {
      outline: 2px solid rgba(106, 100, 92, 0.25);
      border-color: var(--accent);
    }

    button {
      margin-top: 16px;
      width: 100%;
      padding: 10px 12px;
      border: none;
      border-radius: 8px;
      background: var(--accent);
      color: #fff;
      font-size: 14px;
      cursor: pointer;
    }

    .login-message {
      margin-top: 12px;
      min-height: 18px;
      font-size: 13px;
    }

    .login-message[data-state="error"] { color: #a33939; }
    .login-message[data-state="success"] { color: #2f6f4f; }

    .login-links {
      margin-top: 16px;
      text-align: center;
      font-size: 13px;
    }

    .login-links a {
      color: var(--accent);
      text-decoration: none;
    }
  </style>
</head>

<body>
<main class="login-shell">
  <h1 class="login-title">로그인</h1>
  <p class="login-sub">아이디(이메일/휴대폰)와 비밀번호를 입력해주세요.</p>

  <!-- ✅ form action을 쓰지 않고 JS로만 POST 호출 -->
  <form id="login-form" autocomplete="on">
    <label for="loginKey">아이디 / 이메일</label>
    <input id="loginKey" name="loginKey" type="text" autocomplete="username" required />

    <label for="password">비밀번호</label>
    <input id="password" name="password" type="password" autocomplete="current-password" required />

    <button type="submit">로그인</button>
  </form>

  <p id="login-message" class="login-message" role="status" aria-live="polite"></p>

  <div class="login-links">
    <!-- ✅ 상대경로로 쓰지 말고 Thymeleaf 절대경로로 -->
    <a th:href="@{/auth/user/signup}">회원가입</a>
  </div>
</main>

<!-- ✅ API URL: 컨텍스트 경로 변화에도 안전 -->
<script th:inline="javascript">
  const loginApiUrl = /*[[@{/api/v1/auth/login}]]*/ "/api/v1/auth/login";
</script>

<script>
  (function () {
    const form = document.getElementById("login-form");
    const message = document.getElementById("login-message");
    if (!form || !message) return;

    const setMessage = (text, state) => {
      message.textContent = text;
      message.dataset.state = state || "";
    };

    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      const loginKey = form.loginKey.value.trim();
      const password = form.password.value;

      if (!loginKey || !password) {
        setMessage("아이디와 비밀번호를 입력해주세요.", "error");
        return;
      }

      setMessage("로그인 요청 중...", "");

      try {
        const response = await fetch(loginApiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ loginKey, password })
        });

        const data = await response.json().catch(() => ({}));

        // ✅ 너희 API 포맷(success:false/message)도 고려
        if (!response.ok || data.success === false) {
          const errorMessage = data.message || "로그인에 실패했습니다.";
          setMessage(errorMessage, "error");
          return;
        }

        // 성공 처리 (프로젝트에 맞게 리다이렉트 바꿔도 됨)
        if (data && data.nickname) {
          setMessage(`환영합니다, ${data.nickname}님!`, "success");
          return;
        }

        setMessage("로그인 성공", "success");
      } catch (error) {
        setMessage("서버와 통신할 수 없습니다.", "error");
      }
    });
  })();
</script>
</body>
</html>
